# TCP 学习笔记

## TCP 是什么

1. TCP 是稳定、安全的全双工通信的传输层协议
2. TCP 基于字节流进行数据交换
3. 通信连接维护是面向通信的两个端点的，而不考虑中间网段和节点。

## TCP 三次握手四次挥手

首先请求端和接收端要进行TCP连接
1. 请求端发送一个握手请求 并带上SYN = 1 seq = 0
2. 响应端回复这个请求并带上 SYN = 1 Seq = 0 Ack = 1
3. 请求端发送一个接收确认的请求，并带上 Ack = 1 Seq = 1

SYN 是表示将要进行连接的标识位
Seq 是记录自身包体的表示符，两端的操作系统会不停轮换
Ack 是收到响应的应答码，语法是 Ack = seq + 1

断连的时候，通常都是客户端主动进行发起的，也有时候服务端会主动进行发起

那么这时候，

1. 发起方发送一个断连请求，告诉响应方我已经将数据发送完毕了，可以进行关闭连接了
2. 响应方将返回一个应答，告诉发起方，已经接收到发起方想要断开连接的请求，但是此时并不会立即断开连接，响应方还是会继续传输数据
3. 响应方将数据传输完毕后，向发起方发送断连请求，并停止数据的发送
4. 发起方收到响应方的断连请求，将连接断开，响应方接收到断连请求后，也将自身的连接断开

为什么要进行四次挥手，因为TCP是全双工协议，两边都可以互相发送数据，为了稳定地断开连接，就需要先互相通知不要再进行数据传递了
双方都将剩余数据传完之后，再互相断开连接

## TCP 协议怎么保证连接稳定

TCP 协议主要依靠， 流量控制、拥塞控制、快重传、快恢复 四点来保证连接的稳定

### 流量控制

其中流量控制用于控制发送的量，TCP协议建立连接的时候，接收方会告诉请求方此时的接收窗口（rwnd）是多少，然后发送方，将需要发送的报文分为多个数据段

```
 _______ _________ _________ _________ _________
|       |         |         |         |         |
| 0-100 | 100-200 | 200-300 | 300-400 | 400-500 |
|_______|_________|_________|_________|_________|

```

如果此时rwnd=200 那么意味这此时发送方只能够 先将 0-100 和 100 - 200 的报文数据发送完成后， 再发送 200-300 和 300-400 的数据，（滑动窗口在 0-200  200-400 之间滑动）

在传输的过程中，接收方会根据目前的情况不断的调整rwnd，已达到控制发送量

如果此时rwnd为0了，那么发送方就会停止发送，发送方此时会启动一个持续计时器，如果过了一段事件，接收方还没有调整rwnd，那么就会发送一个零窗口的探测包给接收方，让接收方重新返回当前的rwnd

### 拥塞控制

拥塞控制用于控制请求发送的速度 其中包括慢启动和拥塞避免 两个阶段,

慢启动阶段，速度从 每次发送1个请求报文 开始，逐步以 2的指数递增，慢启动不是说启动的速度慢，而是指启动的起点低

当速度 增加到 慢启动门限（ssthresh ） 的时候，速度就不能再以2的指数递增了，这时候就进入了拥塞避免阶段

拥塞避免阶段，发送的速度就以每次增加1个请求报文的加速度不断上涨。

如果这时候在不断上涨的过程中出现了丢包，那么这时候老版本 TCP Tahoe就会将 慢启动门限降低为 启动门限的一半，然后继续从发送速度为1个报文重新进入慢启动阶段

### 快重传

快重传是指当接收方收到一个失序的数据报文后，就立即回包给发送方，当发送方收到三次重复的确认后，将立即重新发送数据报文包
例如，发送方要传 M2 和 M3 两个包给接收方，但是M2 收到了，M3 却丢失了，那么接收方就只会发送M2的确认包，无论后面发送了M4、M5、M6 都只会响应M2的确认包（因为M3 包一直没收到，失序了）当接收方一连收到3个M2的确认包后，就会重新发送M3数据包而不用等到M3 数据包的重传计时器到期

### 快恢复

快恢复 是 新版TCP Reno 用于丢包后快速回复发送速度的算法，老版本 TCP Tahoe 当丢包发生后回将发送的速度降至为 1 然后再开始从慢启动阶段继续
而新版TCP的快恢复允许将发包的速度降至为丢包时速度的一半，让恢复速度 === 慢启动门限值，直接让传输速度直接从拥塞避免阶段继续进行

![resend](/assets/img/quick-resend.png)
